// Copyright 2024-2025 CardinalHQ, Inc
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//     http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

package functions

import (
	"context"
	"testing"

	"github.com/open-telemetry/opentelemetry-collector-contrib/pkg/ottl"
	"github.com/stretchr/testify/assert"
)

func Test_SqlQueryScrub(t *testing.T) {
	tests := []struct {
		name     string
		input    string
		expected string
	}{
		{
			name:     "Scrub single-quoted string and number",
			input:    `SELECT * FROM users WHERE name = "John Doe" AND age = 30;`,
			expected: `SELECT * FROM users WHERE name = ? AND age = ?;`,
		},
		{
			name:     "Scrub numbers and single-quoted strings in INSERT",
			input:    `INSERT INTO products (id, name, price) VALUES (42, 'Laptop', 999.99);`,
			expected: `INSERT INTO products (id, name, price) VALUES (?, ?, ?);`,
		},
		{
			name:     "Scrub timestamps and numbers in UPDATE",
			input:    `UPDATE logs SET message = 'Error occurred at 12:34:56' WHERE id = 1234;`,
			expected: `UPDATE logs SET message = ? WHERE id = ?;`,
		},
		{
			name:     "Scrub alphanumeric order_id and numeric customer_id",
			input:    `DELETE FROM orders WHERE order_id = 'ORD-5678' AND customer_id = 789;`,
			expected: `DELETE FROM orders WHERE order_id = ? AND customer_id = ?;`,
		},
		{
			name:     "Scrub numeric table name ",
			input:    `ALTER TABLE orders_23412312234234234 ADD COLUMN foo VARCHAR;`,
			expected: `ALTER TABLE orders_ ADD COLUMN foo VARCHAR;`,
		},
		{
			name:     "Scrub uuid table name",
			input:    `ALTER TABLE tbl_5960ff07_578a_4e49_a543_db92e8432860 ADD COLUMN foo VARCHAR;`,
			expected: `ALTER TABLE tbl_ ADD COLUMN foo VARCHAR;`,
		},
		{
			name:     "Scrub complex query with multiple replacements",
			input:    `SELECT c.customer_id, c.name, o.order_id, o.total_amount FROM customers c JOIN orders o ON c.customer_id = o.customer_id WHERE c.region = 'US' AND o.order_date >= '2024-01-01' AND o.total_amount > 500;`,
			expected: `SELECT c.customer_id, c.name, o.order_id, o.total_amount FROM customers c JOIN orders o ON c.customer_id = o.customer_id WHERE c.region = ? AND o.order_date >= ? AND o.total_amount > ?;`,
		},
		{
			name:     "Scrub subquery with multiple conditions",
			input:    `SELECT p.product_name, p.price, (SELECT COUNT(*) FROM reviews r WHERE r.product_id = p.product_id AND r.rating >= 4) AS positive_reviews FROM products p WHERE p.category = 'Electronics' AND p.stock > 10 AND p.price BETWEEN 100 AND 1000;`,
			expected: `SELECT p.product_name, p.price, (SELECT COUNT(*) FROM reviews r WHERE r.product_id = p.product_id AND r.rating >= ?) AS positive_reviews FROM products p WHERE p.category = ? AND p.stock > ? AND p.price BETWEEN ? AND ?;`,
		},
		{
			name:     "Merge multiple batched inserts into one",
			input:    `INSERT INTO ? (?,?,?,?,?,?,?,?,?) VALUES (?,?,?,?,?,?,?,?,?),(?,?,?,?,?,?,?,?,?),(?,?,?,?,?,?,?,?,?),(?,?,?,?,?,?,?,?,?),(?,?,?,?,?,?,?,?,?),(?,?,?,?,?,?,?,?,?),(?,?,?,?,?,?,?,?,?),(?,?,?,?,?,?,?,?,?),(?,?,?,?,?,?,?,?,?),(?,?,?,?,?,?,?,?,?),(?,?,?,?,?,?,?,?,?),(?,?,?,?,?,?,?,?,?),(?,?,?,?,?,?,?,?,?),(?,?,?,?,?,?,?,?,?),(?,?,?,?,?,?,?,?,?),(?,?,?,?,?,?,?,?,?),(?,?,?,?,?,?,?,?,?),(?,?,?,?,?,?,?,?,?),(?,?,?,?,?,?,?,?,?),(?,?,?,?,?,?,?,?,?),(?,?,?,?,?,?,?,?,?),(?,?,?,?,?,?,?,?,?),(?,?,?,?,?,?,?,?,?),(?,?,?,?,?,?,?,?,?),(?,?,?,?,?,?,?,?,?),(?,?,?,?,?,?,?,?,?),(?,?,?,?,?,?,?,?,?),(?,?,?,?,?,?,?,?,?),(?,?,?,?,?,?,?,?,?),(?,?,?,?,?,?,?,?,?),(?,?,?,?,?,?,?,?,?),(?,?,?,?,?,?,?,?,?),(?,?,?,?,?,?,?,?,?),(?,?,?,?,?,?,?,?,?),(?,?,?,?,?,?,?,?,?),(?,?,?,?,?,?,?,?,?),(?,?,?,?,?,?,?,?,?),(?,?,?,?,?,?,?,?,?),(?,?,?,?,?,?,?,?,?),(?,?,?,?,?,?,?,?,?),(?,?,?,?,?,?,?,?,?),(?,?,?,?,?,?,?,?,?),(?,?,?,?,?,?,?,?,?),(?,?,?,?,?,?,?,?,?),(?,?,?,?,?,?,?,?,?),(?,?,?,?,?,?,?,?,?),(?,?,?,?,?,?,?,?,?),(?,?,?,?,?,?,?,?,?),(?,?,?,?,?,?,?,?,?),(?,?,?,?,?,?,?,?,?),(?,?,?,?,?,?,?,?,?),(?,?,?,?,?,?,?,?,?),(?,?,?,?,?,?,?,?,?),(?,?,?,?,?,?,?,?,?),(?,?,?,?,?,?,?,?,?),(?,?,?,?,?,?,?,?,?),(?,?,?,?,?,?,?,?,?),(?,?,?,?,?,?,?,?,?),(?,?,?,?,?,?,?,?,?),(?,?,?,?,?,?,?,?,?),(?,?,?,?,?,?,?,?,?),(?,?,?,?,?,?,?,?,?),(?,?,?,?,?,?,?,?,?),(?,?,?,?,?,?,?,?,?),(?,?,?,?,?,?,?,?,?),(?,?,?,?,?,?,?,?,?),(?,?,?,?,?,?,?,?,?),(?,?,?,?,?,?,?,?,?),(?,?,?,?,?,?,?,?,?),(?,?,?,?,?,?,?,?,?),(?,?,?,?,?,?,?,?,?),(?,?,?,?,?,?,?,?,?),(?,?,?,?,?,?,?,?,?),(?,?,?,?,?,?,?,?,?),(?,?,?,?,?,?,?,?,?),(?,?,?,?,?,?,?,?,?),(?,?,?,?,?,?,?,?,?),(?,?,?,?,?,?,?,?,?),(?,?,?,?,?,?,?,?,?),(?,?,?,?,?,?,?,?,?),(?,?,?,?,?,?,?,?,?),(?,?,?,?,?,?,?,?,?),(?,?,?,?,?,?,?,?,?),(?,?,?,?,?,?,?,?,?),(?,?,?,?,?,?,?,?,?),(?,?,?,?,?,?,?,?,?),(?,?,?,?,?,?,?,?,?),(?,?,?,?,?,?,?,?,?),(?,?,?,?,?,?,?,?,?),(?,?,?,?,?,?,?,?,?),(?,?,?,?,?,?,?,?,?),(?,?,?,?,?,?,?,?,?) ON CONFLICT (?) DO UPDATE SET ?=?.?,?=?.?,?=?.?,?=?.?,?=?.?,?=?.?,?=?.?,?=?.?`,
			expected: `INSERT INTO ? (?) VALUES (?) ON CONFLICT (?) DO UPDATE SET ?=?`,
		},
		{
			name:     "Scrub multiple batched inserts into one - part 2",
			input:    `INSERT INTO ? (?) VALUES (?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL),(?,?,?,?,?,?,?,?,NULL) ON CONFLICT (?) DO UPDATE SET ?=?.?`,
			expected: `INSERT INTO ? (?) VALUES (?) ON CONFLICT (?) DO UPDATE SET ?=?`,
		},
		{
			name:     "Scrub multiple batched inserts into one - part 3 - variable IN clause",
			input:    `SELECT * FROM ? WHERE customer_id = ? AND name IN (?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)`,
			expected: `SELECT * FROM ? WHERE customer_id = ? AND name IN (?)`,
		},
		{
			name:     "PII query",
			input:    `SELECT * FROM 'c_organization_api_keys' WHERE api_key = 'demo-app-api-key' AND enabled = true ORDER BY 'c_organization_api_keys'.'id' LIMIT 1`,
			expected: `SELECT * FROM ? WHERE api_key = ? AND enabled = true ORDER BY ?.? LIMIT ?`,
		},
		{
			name:     "De-dupe repeating ? VARCHAR",
			input:    `CREATE TABLE test (? VARCHAR, ? VARCHAR, ? BIGINT, ? BIGINT, ? VARCHAR)`,
			expected: `CREATE TABLE test ()`,
		},
	}

	for _, tt := range tests {
		t.Run(tt.name, func(t *testing.T) {
			exprFunc := dbQueryScrub[any](&ottl.StandardStringGetter[any]{
				Getter: func(context.Context, any) (any, error) {
					return tt.input, nil
				},
			})
			result, err := exprFunc(context.Background(), nil)

			assert.NoError(t, err)
			assert.Equal(t, tt.expected, result)
		})
	}
}
